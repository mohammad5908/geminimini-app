'use client';
import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { BarChart, Bar, XAxis, YAxis, ResponsiveContainer, CartesianGrid, Tooltip } from 'recharts';
import { ShoppingBag, Heart, Star, Zap, TrendingUp, Gift, Lock, Truck, Clock, Percent, Users, Award, Sparkles, Send, MessageCircle, ArrowRight, Check, AlertCircle, Flame, Eye, Share2, Home, User, Menu, Search, Filter, ChevronRight, Copy, Plus, Minus, Trash2, Phone, Mail, CreditCard, Volume2, Bell, X as CloseIcon, RotateCcw, LogOut } from 'lucide-react';

// ============================================================================
// ZUSTAND STORE
// ============================================================================
const useUltimateStore = create(persist((set, get) => ({
  user: { id: '8821', name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ', email: 'ali@example.com', phone: '09120000000', balance: 5000000, level: 'VIP Gold', points: 2847, badges: ['first-purchase', 'super-buyer', '5-star-reviewer'], purchaseCount: 23, referralCode: 'ALI-8821-VIP', referredCount: 12 },
  cart: [],
  favorites: [],
  orders: [{ id: 'ORD-001', date: '1402/09/20', amount: 450000, status: 'delivered', items: 3 }, { id: 'ORD-002', date: '1402/09/15', amount: 850000, status: 'delivered', items: 5 }],
  notifications: [],
  messages: [],
  theme: 'dark',
  activeTab: 'home',
  addToCart: (product) => set(state => ({ cart: [...state.cart, { ...product, cartId: `${product.id}-${Date.now()}`, quantity: 1 }] })),
  removeFromCart: (cartId) => set(state => ({ cart: state.cart.filter(item => item.cartId !== cartId) })),
  updateQuantity: (cartId, quantity) => set(state => ({ cart: state.cart.map(item => item.cartId === cartId ? { ...item, quantity: Math.max(1, Math.min(quantity, 100)) } : item) })),
  toggleFavorite: (productId) => set(state => ({ favorites: state.favorites.includes(productId) ? state.favorites.filter(id => id !== productId) : [...state.favorites, productId] })),
  checkout: (amount) => set(state => { const total = Math.max(0, amount); if (state.user.balance < total) return state; return { cart: [], user: { ...state.user, balance: state.user.balance - total, purchaseCount: state.user.purchaseCount + 1, points: state.user.points + Math.floor(total / 10000) }, orders: [...state.orders, { id: `ORD-${Date.now()}`, date: new Date().toLocaleDateString('fa-IR'), amount: total, status: 'processing', items: state.cart.length }] }; }),
  addNotification: (notification) => set(state => ({ notifications: [...state.notifications, { ...notification, id: Date.now() }] })),
  removeNotification: (id) => set(state => ({ notifications: state.notifications.filter(n => n.id !== id) })),
  setTab: (tab) => set({ activeTab: tab }),
  setTheme: (theme) => set({ theme }),
  clearCart: () => set({ cart: [] }),
}), { name: 'gemini-ultimate-store' }));

// ============================================================================
// PRODUCTS DATABASE
// ============================================================================
const PRODUCTS = [
  { id: 1, name: 'Ø§Ø´ØªØ±Ø§Ú© Ø·Ù„Ø§ÛŒÛŒ Û± Ù…Ø§Ù‡Ù‡', price: 299000, originalPrice: 450000, discount: 33, category: 'subscription', image: 'ğŸ‘‘', color: 'from-yellow-500 to-orange-500', rating: 4.9, reviews: 2847, sales: 15420, hot: true, flashSale: true, flashEndsIn: '02:45:30', description: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ØªÙ…Ø§Ù… ÙÛŒÚ†Ø±Ù‡Ø§', features: ['Ø¯Ø³ØªØ±Ø³ÛŒ Û²Û´/Û·', 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ', 'Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'], inStock: true, seller: 'Gemini Center', delivery: 'Û±-Û² Ø³Ø§Ø¹Øª', warranty: 'Û³Û° Ø±ÙˆØ²' },
  { id: 2, name: 'Ø§Ø´ØªØ±Ø§Ú© Ø§Ù„Ù…Ø§Ø³ÛŒ Û³ Ù…Ø§Ù‡Ù‡', price: 799000, originalPrice: 1200000, discount: 33, category: 'subscription', image: 'ğŸ’', color: 'from-purple-500 to-pink-500', rating: 4.95, reviews: 5234, sales: 28960, hot: true, flashSale: true, flashEndsIn: '02:45:30', description: 'Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§ Û³Û°Ùª ØµØ±ÙÙ‡â€ŒØ¬ÙˆÛŒÛŒ', features: ['API Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯', 'Ø§ÙˆÙ„ÙˆÛŒØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', 'Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ÛŒÚ¯Ø§Ù†'], inStock: true, seller: 'Gemini Center', delivery: 'ÙÙˆØ±ÛŒ', warranty: 'Û¹Û° Ø±ÙˆØ²', badge: 'BESTSELLER' },
  { id: 3, name: 'Ø§Ø´ØªØ±Ø§Ú© Ù¾Ù„Ø§ØªÛŒÙ†ÛŒ Û¶ Ù…Ø§Ù‡Ù‡', price: 1499000, originalPrice: 2400000, discount: 37, category: 'subscription', image: 'â­', color: 'from-blue-500 to-cyan-500', rating: 4.98, reviews: 8932, sales: 42850, hot: true, description: 'Ù¾Ú©ÛŒØ¬ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±Ù‡Ø§', features: ['Ù…Ø´Ø§ÙˆØ±Ù‡ Ø´Ø®ØµÛŒ', 'Ø¢Ù†Ø§Ù„ÙŠØªÛŒÚ© Ù¾ÛŒØ´Ø±ÙØªÙ‡', 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³ÙØ§Ø±Ø´ÛŒ'], inStock: true, seller: 'Gemini Center', delivery: 'ÙÙˆØ±ÛŒ', warranty: 'Û¶ Ù…Ø§Ù‡Ù‡', badge: 'TOP CHOICE' },
  { id: 4, name: 'API Premium Bundle', price: 449000, originalPrice: 650000, discount: 30, category: 'api', image: 'âš™ï¸', color: 'from-green-500 to-emerald-500', rating: 4.85, reviews: 3421, sales: 9875, description: 'Û±Û°Û°Û°Û° Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø±Ø«Ø§Ù†ÛŒÙ‡', features: ['ØªØ­Ù…Ù„ Ø¨Ø§Ù„Ø§', 'Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚', 'ØªÛŒÙ… Û²Û´/Û·'], inStock: true, seller: 'Gemini Center', delivery: 'Û± Ø³Ø§Ø¹Øª' },
  { id: 5, name: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ', price: 199000, originalPrice: 350000, discount: 43, category: 'support', image: 'ğŸ“', color: 'from-red-500 to-pink-500', rating: 4.92, reviews: 6754, sales: 31200, hot: true, description: 'Ù¾Ø§Ø³Ø® ÙÙˆØ±ÛŒ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª', features: ['Chat ÙÙˆØ±ÛŒ', 'ÙˆÛŒØ¯Ø¦Ùˆ Ú©Ø§Ù„', 'Ø§ÛŒÙ…ÛŒÙ„+ØªÙ„ÙÙ†'], inStock: true, seller: 'Gemini Center', delivery: 'ÙÙˆØ±ÛŒ' },
  { id: 6, name: 'Analytics Pro', price: 299000, originalPrice: 500000, discount: 40, category: 'analytics', image: 'ğŸ“Š', color: 'from-indigo-500 to-blue-500', rating: 4.88, reviews: 4521, sales: 12340, description: 'ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡', features: ['Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±ÛŒØ¦Ù„â€ŒØªØ§ÛŒÙ…', 'Export PDF', 'AI predictions'], inStock: true },
  { id: 7, name: 'SEO Optimizer', price: 399000, originalPrice: 700000, discount: 43, category: 'seo', image: 'ğŸ”', color: 'from-orange-500 to-red-500', rating: 4.91, reviews: 5678, sales: 18950, description: 'Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ SEO Ø®ÙˆØ¯Ú©Ø§Ø±', features: ['Keyword research', 'Backlink checker', 'Rank tracking'], inStock: true },
  ...Array(13).fill(null).map((_, i) => ({ id: i + 8, name: `Ù…Ø­ØµÙˆÙ„ Premium ${i + 1}`, price: 199000 + i * 50000, originalPrice: 350000 + i * 75000, discount: Math.floor(40 - i % 20), category: 'services', image: ['ğŸ', 'ğŸ’', 'ğŸ€', 'ğŸŠ', 'ğŸŒŸ', 'âœ¨', 'ğŸ”¥', 'ğŸš€', 'ğŸ’¼', 'ğŸ¯', 'âš¡', 'ğŸ†', 'ğŸ‘‘'][i], color: ['from-rose-500 to-pink-500', 'from-fuchsia-500 to-purple-500', 'from-violet-500 to-indigo-500', 'from-indigo-500 to-blue-500', 'from-blue-500 to-cyan-500', 'from-cyan-500 to-emerald-500', 'from-emerald-500 to-green-500', 'from-green-500 to-lime-500', 'from-lime-500 to-yellow-500', 'from-yellow-500 to-orange-500', 'from-orange-500 to-red-500', 'from-red-500 to-pink-500', 'from-pink-500 to-rose-500'][i], rating: 4.7 + Math.random() * 0.25, reviews: 2000 + i * 500, sales: 8000 + i * 1200, description: `Ø®Ø¯Ù…Ø§Øª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ØªÛŒÙ… ${i + 1}`, features: ['Support full', 'Ú©ÙˆØ§Ù„ÛŒØªÛŒ Ø¹Ø§Ù„ÛŒ', 'ØªØ­ÙˆÛŒÙ„ Ø³Ø±ÛŒØ¹'], inStock: Math.random() > 0.1 }))
];

// ============================================================================
// ANIMATIONS
// ============================================================================
const ANIMATIONS = {
  container: { hidden: { opacity: 0 }, visible: { opacity: 1, transition: { staggerChildren: 0.08 } } },
  item: { hidden: { opacity: 0, y: 20 }, visible: { opacity: 1, y: 0, transition: { type: 'spring', stiffness: 100 } } },
  slideIn: { hidden: { x: 50, opacity: 0 }, visible: { x: 0, opacity: 1 } },
  pulse: { scale: [1, 1.05, 1], transition: { duration: 2, repeat: Infinity } },
  fadeIn: { initial: { opacity: 0 }, animate: { opacity: 1 }, exit: { opacity: 0 } },
};

const TESTIMONIALS = [
  { name: 'Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ÛŒ', role: 'Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´', text: 'Ø¨Ù‡ØªØ±ÛŒÙ† Ø³Ø±ÙˆÛŒØ³ÛŒ Ú©Ù‡ ØªØ§ Ø­Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯Ù…! ğŸŒŸ', avatar: 'ğŸ‘¨â€ğŸ’¼', rating: 5 },
  { name: 'ÙØ§Ø·Ù…Ù‡ Ø§Ø­Ù…Ø¯ÛŒ', role: 'Ú©Ø§Ø±Ø¢ÙØ±ÛŒÙ†', text: 'Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø± Ù…Ù† Û³Û°Û°Ùª Ø±Ø´Ø¯ Ú©Ø±Ø¯!', avatar: 'ğŸ‘©â€ğŸ’¼', rating: 5 },
  { name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ', role: 'Ù…Ù‡Ù†Ø¯Ø³', text: 'Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¹Ø§Ù„ÛŒ Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³Ø±ÛŒØ¹', avatar: 'ğŸ‘¨â€ğŸ’»', rating: 5 },
];

// ============================================================================
// COMPONENTS
// ============================================================================

const Toast = ({ notification, onClose }) => {
  useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
  const bgColor = { success: 'from-green-500 to-emerald-500', error: 'from-red-500 to-pink-500', warning: 'from-yellow-500 to-orange-500', info: 'from-blue-500 to-cyan-500' }[notification.type] || 'from-purple-500 to-pink-500';
  return <motion.div initial={{ opacity: 0, x: 100 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: 100 }} className={`bg-gradient-to-r ${bgColor} text-white px-6 py-3 rounded-xl shadow-xl flex items-center justify-between`}><span className="text-sm font-medium">{notification.message}</span><button onClick={onClose} className="ml-3"><CloseIcon size={16} /></button></motion.div>;
};

const PremiumButton = ({ children, onClick, variant = 'primary', size = 'md', disabled, className, animated }) => {
  const variants = { primary: `bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white ${disabled ? 'opacity-50' : 'shadow-lg shadow-purple-500/50 hover:shadow-purple-500/75'}`, secondary: 'bg-white/10 backdrop-blur text-white border border-white/20 hover:bg-white/20', outline: 'border-2 border-white/30 text-white hover:border-white/50' };
  const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-6 py-3 text-base', lg: 'px-8 py-4 text-lg' };
  return <motion.button whileHover={disabled ? {} : { scale: 1.05 }} whileTap={disabled ? {} : { scale: 0.95 }} disabled={disabled} onClick={onClick} className={`rounded-2xl font-bold transition-all ${variants[variant]} ${sizes[size]} ${className}`} {...(animated && { animate: ANIMATIONS.pulse })}>{children}</motion.button>;
};

const CountdownTimer = ({ endTime = '02:45:30' }) => {
  const [time, setTime] = useState(endTime);
  const [isEnded, setIsEnded] = useState(false);
  useEffect(() => { const interval = setInterval(() => { setTime(prev => { const [h, m, s] = prev.split(':').map(Number); let newS = s - 1, newM = m, newH = h; if (newS < 0) { newS = 59; newM--; } if (newM < 0) { newM = 59; newH--; } if (newH === 0 && newM === 0 && newS === 0) { setIsEnded(true); return '00:00:00'; } return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}:${String(newS).padStart(2, '0')}`; }); }, 1000); return () => clearInterval(interval); }, []);
  if (isEnded) return <span className="text-red-400 text-sm font-bold">Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª</span>;
  return <div className="flex items-center gap-1 text-orange-400 font-bold text-sm"><Flame size={16} className="animate-pulse" />{time}</div>;
};

const UltimateProductCard = ({ product, onAddCart, onFavorite, isFavorite }) => {
  return <motion.div variants={ANIMATIONS.item} whileHover={{ y: -8 }} className="relative bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl overflow-hidden border border-white/10 hover:border-purple-500/50 transition-all group h-full flex flex-col">
    <div className="absolute top-4 right-4 left-4 z-10 flex gap-2 flex-wrap">{product.hot && <div className="bg-gradient-to-r from-red-500 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Flame size={14} /> Ø¯Ø§Øº</div>}{product.badge && <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-xs font-bold">{product.badge}</div>}</div>
    <div className={`h-48 bg-gradient-to-br ${product.color} flex items-center justify-center text-6xl relative overflow-hidden flex-shrink-0`} role="img" aria-label={product.name}><motion.div animate={ANIMATIONS.pulse} className="absolute inset-0 bg-white/10" /><span className="relative z-10 text-5xl">{product.image}</span><div className="absolute bottom-3 left-3 bg-black/60 backdrop-blur px-2 py-1 rounded-lg text-xs text-white flex items-center gap-1"><TrendingUp size={14} /> {(product.sales / 1000).toFixed(1)}K</div></div>
    <div className="p-5 space-y-4 flex-grow flex flex-col"><h3 className="text-base font-bold text-white line-clamp-2">{product.name}</h3>
    <div className="flex items-center gap-2"><div className="flex gap-0.5">{[...Array(5)].map((_, i) => <Star key={`star-${i}`} size={14} className={i < Math.floor(product.rating) ? 'fill-yellow-400 text-yellow-400' : 'text-gray-600'} />)}</div><span className="text-xs text-gray-400">({(product.reviews / 1000).toFixed(1)}K)</span></div>
    <div className="space-y-2"><div className="flex items-center gap-2 flex-wrap"><span className="text-2xl font-black text-white">{(product.price / 1000).toFixed(0)}K</span>{product.originalPrice && <span className="text-xs text-gray-500 line-through">{(product.originalPrice / 1000).toFixed(0)}K</span>}{product.discount && <span className="bg-red-500/20 text-red-400 px-2 py-1 rounded text-xs font-bold">{product.discount}%</span>}</div>{product.flashSale && <CountdownTimer endTime={product.flashEndsIn} />}</div>
    <div className="flex items-center gap-2 text-sm"><Check className={product.inStock ? 'text-green-500' : 'text-red-500'} size={16} /><span className={product.inStock ? 'text-green-400 text-xs' : 'text-red-400 text-xs'}>{product.inStock ? `${Math.floor(Math.random() * 50) + 10} Ù…ÙˆØ¬ÙˆØ¯` : 'ØªÙ…Ø§Ù… Ø´Ø¯Ù‡'}</span></div>
    <div className="space-y-1 flex-grow">{product.features.slice(0, 2).map((feature, idx) => <div key={`feat-${idx}`} className="text-xs text-gray-400 flex items-center gap-2"><ChevronRight size={12} className="text-purple-500" />{feature}</div>)}</div>
    <div className="pt-4 space-y-3 border-t border-white/10"><PremiumButton onClick={() => onAddCart(product)} className="w-full" disabled={!product.inStock}><ShoppingBag size={16} className="inline ml-2" />Ø®Ø±ÛŒØ¯Ø§Ø±</PremiumButton><button onClick={() => onFavorite(product.id)} className={`w-full py-2 rounded-lg border transition-all text-xs font-medium ${isFavorite ? 'border-pink-500 bg-pink-500/20 text-pink-400' : 'border-white/20 text-white hover:border-pink-500'}`}><Heart size={14} className={`inline ml-2 ${isFavorite ? 'fill-pink-500' : ''}`} />{isFavorite ? 'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡' : 'Ø°Ø®ÛŒØ±Ù‡'}</button></div>
    </div>
  </motion.div>;
};

const CartSummary = ({ cart }) => {
  const { total, discount } = useMemo(() => { const t = cart.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0); const d = cart.reduce((sum, item) => sum + ((item.originalPrice || item.price) - (item.price || 0)) * (item.quantity || 1), 0); return { total: t, discount: d }; }, [cart]);
  const tax = Math.floor(total * 0.09);
  const final = total + tax;
  return <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="space-y-3 bg-white/5 backdrop-blur p-4 rounded-2xl border border-white/10"><div className="space-y-2 text-sm"><div className="flex justify-between text-gray-400"><span>Ù‚ÛŒÙ…Øª Ú©Ù„:</span><span>{(total / 1000).toFixed(1)}K</span></div>{discount > 0 && <div className="flex justify-between text-green-400"><span>ØªØ®ÙÛŒÙ:</span><span>-{(discount / 1000).toFixed(1)}K</span></div>}<div className="flex justify-between text-blue-400"><span>Ù…Ø§Ù„ÛŒØ§Øª (Û¹%):</span><span>{(tax / 1000).toFixed(1)}K</span></div><div className="h-px bg-white/10" /><div className="flex justify-between text-lg font-bold text-white"><span>Ú©Ù„:</span><span>{(final / 1000).toFixed(1)}K</span></div></div></motion.div>;
};

const AIChatSeller = ({ isOpen, onClose }) => {
  const [messages, setMessages] = useState([{ id: 0, sender: 'bot', text: 'ğŸ‘‹ Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± ÙØ±ÙˆØ´ Gemini Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ú©Ù…Ú© Ú©Ù†Ù…?' }]);
  const [input, setInput] = useState('');
  const messagesEndRef = useRef(null);
  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);
  const handleSend = useCallback(() => { if (!input.trim()) return; const userMsg = { id: Date.now(), sender: 'user', text: input }; setMessages(prev => [...prev, userMsg]); setInput(''); setTimeout(() => { const responses = ['Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Û³Û°Ùª ØªØ®ÙÛŒÙ Ø¯Ø§Ø±Ù‡! ğŸ‰', 'Ø¢ÛŒØ§ Ø³ÙˆØ§Ù„ Ø¯ÛŒÚ¯Ø±ÛŒØŸ ğŸ˜Š', 'Ù¾Ú©ÛŒØ¬ Ø´Ø§Ù…Ù„ Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Û¹Û° Ø±ÙˆØ²Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª!', 'Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ø´Ù…Ø§! ğŸ’¡']; const response = responses[Math.floor(Math.random() * responses.length)]; setMessages(prev => [...prev, { id: Date.now(), sender: 'bot', text: response }]); }, 800); }, [input]);
  return <AnimatePresence>{isOpen && <motion.div {...ANIMATIONS.fadeIn} initial={{ opacity: 0, y: 100, scale: 0.9 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: 100, scale: 0.9 }} className="fixed bottom-24 left-4 right-4 max-w-md mx-auto bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl border border-white/10 shadow-2xl z-50 flex flex-col h-96 overflow-hidden"><div className="p-4 border-b border-white/10 flex justify-between items-center flex-shrink-0"><span className="font-bold text-white text-sm">AI Seller ğŸ¤–</span><button onClick={onClose} className="text-gray-400 hover:text-white transition-colors"><CloseIcon size={18} /></button></div><div className="flex-1 overflow-y-auto p-4 space-y-3">{messages.map(msg => <motion.div key={msg.id} initial={{ opacity: 0, x: msg.sender === 'user' ? 20 : -20 }} animate={{ opacity: 1, x: 0 }} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-xs px-4 py-2 rounded-2xl text-sm ${msg.sender === 'user' ? 'bg-purple-600 text-white' : 'bg-white/10 text-gray-200'}`}>{msg.text}</div></motion.div>)}<div ref={messagesEndRef} /></div><div className="p-4 border-t border-white/10 flex gap-2 flex-shrink-0"><input value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSend()} placeholder="Ø³ÙˆØ§Ù„Øª..." className="flex-1 bg-white/10 border border-white/20 text-white rounded-2xl px-4 py-2 text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500" autoComplete="off" /><button onClick={handleSend} className="bg-purple-600 text-white p-2 rounded-full hover:bg-purple-500 transition-all flex-shrink-0"><Send size={16} /></button></div></motion.div>}</AnimatePresence>;
};

const StatsDashboard = ({ user }) => {
  const stats = [
    { id: 'purchases', label: 'Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§', value: user.purchaseCount, icon: ShoppingBag, color: 'from-blue-500 to-blue-600' },
    { id: 'points', label: 'Ø§Ù…ØªÛŒØ§Ø²Ø§Øª', value: user.points, icon: Star, color: 'from-yellow-500 to-orange-500' },
    { id: 'level', label: 'Ø³Ø·Ø­', value: user.level, icon: Award, color: 'from-purple-500 to-pink-500' },
    { id: 'referrals', label: 'Ø¯ÙˆØ³ØªØ§Ù†', value: user.referredCount, icon: Users, color: 'from-green-500 to-emerald-500' },
  ];
  return <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="grid grid-cols-2 gap-3">{stats.map((stat) => <motion.div key={stat.id} variants={ANIMATIONS.item} className={`bg-gradient-to-br ${stat.color} p-4 rounded-2xl text-white text-center`}><stat.icon size={20} className="opacity-70 mx-auto mb-2" /><div className="text-2xl font-bold">{stat.value}</div><div className="text-xs opacity-75">{stat.label}</div></motion.div>)}</motion.div>;
};

// ============================================================================
// TABS
// ============================================================================

const HomeTab = ({ onChatOpen }) => {
  const { user } = useUltimateStore();
  return <motion.div variants={ANIMATIONS.container} initial="hidden" animate="visible" className="space-y-6 pb-32">
    <motion.div variants={ANIMATIONS.item} className="relative bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 rounded-3xl p-6 overflow-hidden"><div className="absolute inset-0 opacity-10"><div className="absolute w-40 h-40 bg-white rounded-full blur-3xl -top-10 -left-10" /><div className="absolute w-40 h-40 bg-white rounded-full blur-3xl bottom-0 right-0" /></div><div className="relative z-10"><h1 className="text-3xl font-black text-white mb-2">Ø³Ù„Ø§Ù… {user.name}! ğŸ‘‹</h1><p className="text-white/80 text-sm">Ø´Ù…Ø§ {user.level} Ù‡Ø³ØªÛŒØ¯</p><PremiumButton variant="secondary" size="sm" className="mt-4">Ø¬ÙˆØ§ÛŒØ² Ø¨ÛŒØ´ØªØ± â­</PremiumButton></div></motion.div>
    <motion.div variants={ANIMATIONS.item}><h2 className="text-lg font-bold text-white mb-3">Ø¢Ù…Ø§Ø± Ø´Ù…Ø§</h2><StatsDashboard user={user} /></motion.div>
    <motion.div variants={ANIMATIONS.item} className="bg-gradient-to-r from-orange-500 to-red-500 rounded-3xl p-6 text-white"><div className="flex items-center justify-between mb-3"><h3 className="text-xl font-bold flex items-center gap-2"><Flame size={20} /> ÙØ±ÙˆØ´ ÙÙ„Ø´</h3><CountdownTimer /></div><p className="text-sm opacity-90 mb-4">ØªØ§ ÛµÛ°Ùª ØªØ®ÙÛŒÙ!</p><PremiumButton variant="secondary" className="w-full text-xs py-2">Ø¯ÛŒØ¯Ù† Ù‡Ù…Ù‡ <ArrowRight size={14} className="inline ml-2" /></PremiumButton></motion.div>
    <motion.div variants={ANIMATIONS.item}><h2 className="text-lg font-bold text-white mb-3">Ù†Ø¸Ø± Ù…Ø´ØªØ±ÛŒØ§Ù†</h2><div className="space-y-3">{TESTIMONIALS.map((testimonial, i) => <motion.div key={`testimonial-${i}`} variants={ANIMATIONS.item} className="bg-white/5 border border-white/10 rounded-2xl p-4"><div className="flex items-center gap-3 mb-2"><span className="text-3xl">{testimonial.avatar}</span><div><h4 className="font-bold text-white text-sm">{testimonial.name}</h4><p className="text-xs text-gray-400">{testimonial.role}</p></div></div><p className="text-sm text-gray-300 mb-2">{testimonial.text}</p><div className="flex gap-0.5">{[...Array(testimonial.rating)].map((_, idx) => <Star key={`tstar-${idx}`} size={12} className="fill-yellow-400 text-yellow-400" />)}</div></motion.div>)}</div></motion.div>
    <motion.button variants={ANIMATIONS.item} onClick={onChatOpen} className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-2xl font-bold hover:shadow-lg transition-all text-sm">Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ ğŸ¤–</motion.button>
  </motion.div>;
};

const ShopTab = () => {
  const { favorites, addToCart, toggleFavorite } = useUltimateStore();
  const [search, setSearch] = useState('');
  const filteredProducts = useMemo(() => PRODUCTS.filter(p => p.name.includes(search) || p.description.includes(search)), [search]);
  return <motion.div variants={ANIMATIONS.container} initial="hidden" animate="visible" className="space-y-4 pb-32">
    <motion.div variants={ANIMATIONS.item} className="flex gap-2"><div className="flex-1 bg-white/10 border border-white/20 rounded-2xl px-4 py-2 flex items-center gap-2"><Search size={16} className="text-gray-400" /><input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="Ø¬Ø³ØªØ¬Ùˆ..." className="flex-1 bg-transparent outline-none text-white placeholder-gray-500 text-sm" /></div><button className="bg-white/10 hover:bg-white/20 border border-white/20 p-2 rounded-2xl transition-all"><Filter size={18} className="text-white" /></button></motion.div>
    <motion.div variants={ANIMATIONS.container} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{filteredProducts.map(product => <UltimateProductCard key={`product-${product.id}`} product={product} onAddCart={addToCart} onFavorite={toggleFavorite} isFavorite={favorites.includes(product.id)} />)}</motion.div>
    {filteredProducts.length === 0 && <motion.div variants={ANIMATIONS.item} className="text-center py-12"><Eye size={48} className="mx-auto text-gray-600 mb-2" /><p className="text-gray-400">Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p></motion.div>}
  </motion.div>;
};

const CartTab = () => {
  const { cart, removeFromCart, updateQuantity, checkout, user, addNotification } = useUltimateStore();
  const { total, discount } = useMemo(() => { const t = cart.reduce((sum, item) => sum + (item.price || 0) * (item.quantity || 1), 0); const d = cart.reduce((sum, item) => sum + ((item.originalPrice || item.price) - (item.price || 0)) * (item.quantity || 1), 0); return { total: t, discount: d }; }, [cart]);
  const handleCheckout = useCallback(() => { if (cart.length === 0) { addNotification({ type: 'warning', message: 'Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!' }); return; } if (user.balance < total) { addNotification({ type: 'error', message: 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!' }); return; } checkout(total); addNotification({ type: 'success', message: `âœ… Ø®Ø±ÛŒØ¯Ø§Ø± ØªÚ©Ù…ÛŒÙ„! (${(total / 1000).toFixed(1)}K)` }); }, [cart, total, user.balance, checkout, addNotification]);
  return <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-4 pb-32">
    {cart.length === 0 ? <div className="flex flex-col items-center justify-center py-20 text-gray-400"><ShoppingBag size={48} className="mb-4 opacity-50" /><p className="text-sm">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p></div> : <>
      <div className="space-y-3">{cart.map((item) => <motion.div key={item.cartId} initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} className="bg-white/5 border border-white/10 rounded-2xl p-4 flex gap-4"><div className={`h-20 w-20 bg-gradient-to-br ${item.color} rounded-xl flex items-center justify-center text-3xl flex-shrink-0`}>{item.image}</div><div className="flex-1"><h4 className="font-bold text-white text-sm">{item.name}</h4><p className="text-xs text-gray-400">{(item.price / 1000).toFixed(1)}K</p><div className="flex items-center gap-2 mt-2"><button onClick={() => updateQuantity(item.cartId, item.quantity - 1)} className="bg-white/10 p-1 rounded hover:bg-white/20"><Minus size={14} /></button><span className="text-xs w-8 text-center">{item.quantity}</span><button onClick={() => updateQuantity(item.cartId, item.quantity + 1)} className="bg-white/10 p-1 rounded hover:bg-white/20"><Plus size={14} /></button></div></div><button onClick={() => removeFromCart(item.cartId)} className="text-red-500 hover:text-red-400 flex-shrink-0"><Trash2 size={18} /></button></motion.div>)}</div>
      <CartSummary cart={cart} />
      <PremiumButton onClick={handleCheckout} className="w-full py-4"><CreditCard size={16} className="inline ml-2" />ØªÚ©Ù…ÛŒÙ„ Ø®Ø±ÛŒØ¯Ø§Ø±</PremiumButton>
      <div className="grid grid-cols-3 gap-2 text-center text-xs text-gray-400"><div className="flex flex-col items-center gap-1"><Lock size={16} className="text-green-500" />Ø§Ù…Ù†</div><div className="flex flex-col items-center gap-1"><Truck size={16} className="text-blue-500" />Ø³Ø±ÛŒØ¹</div><div className="flex flex-col items-center gap-1"><RotateCcw size={16} className="text-orange-500" />Ø¨Ø±Ú¯Ø´Øª</div></div>
    </>}
  </motion.div>;
};

const ProfileTab = () => {
  const { user } = useUltimateStore();
  const copyToClipboard = useCallback(async () => { await navigator.clipboard.writeText(user.referralCode); alert('Ú©Ù¾ÛŒ Ø´Ø¯! âœ“'); }, [user.referralCode]);
  return <motion.div variants={ANIMATIONS.container} initial="hidden" animate="visible" className="space-y-6 pb-32">
    <motion.div variants={ANIMATIONS.item} className="relative bg-gradient-to-br from-purple-600 to-pink-600 rounded-3xl p-6 text-white overflow-hidden"><div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full blur-3xl -mr-20 -mt-20" /><div className="relative z-10"><div className="text-6xl mb-4">ğŸ‘¤</div><h2 className="text-2xl font-bold">{user.name}</h2><p className="text-white/80 text-sm">{user.email}</p><div className="mt-4 flex items-center gap-2 flex-wrap"><span className="bg-white/20 px-3 py-1 rounded-full text-xs">{user.level}</span><span className="bg-white/20 px-3 py-1 rounded-full text-xs flex items-center gap-1"><Star size={12} className="fill-yellow-300 text-yellow-300" />{user.points}</span></div></div></motion.div>
    <motion.div variants={ANIMATIONS.item}><StatsDashboard user={user} /></motion.div>
    <motion.div variants={ANIMATIONS.item} className="bg-white/5 border border-white/10 rounded-2xl p-4"><h3 className="text-xs font-bold text-gray-400 mb-2">Ú©Ø¯ Ø¯Ø¹ÙˆØª</h3><div className="flex items-center gap-2"><input type="text" value={user.referralCode} readOnly className="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white font-mono text-sm outline-none" /><button onClick={copyToClipboard} className="bg-purple-600 p-2 rounded-lg hover:bg-purple-500 transition-all flex-shrink-0"><Copy size={16} className="text-white" /></button></div></motion.div>
    <motion.div variants={ANIMATIONS.item} className="space-y-2">{[{ icon: CreditCard, label: 'Ú©ÛŒÙ Ù¾ÙˆÙ„', value: `${(user.balance / 1000).toFixed(1)}K` }, { icon: ShoppingBag, label: 'Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§', value: `${user.purchaseCount} Ø¹Ø¯Ø¯` }, { icon: Award, label: 'Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§', value: `${user.badges.length} Ø¹Ø¯Ø¯` }, { icon: MessageCircle, label: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', value: '24/7' }].map((item, i) => <motion.div key={`profile-item-${i}`} whileHover={{ x: 4 }} className="flex items-center justify-between bg-white/5 border border-white/10 hover:border-purple-500/50 rounded-2xl p-4 transition-all cursor-pointer"><div className="flex items-center gap-3"><item.icon size={18} className="text-purple-500" /><span className="font-medium text-white text-sm">{item.label}</span></div><span className="text-xs text-gray-400">{item.value}</span></motion.div>)}</motion.div>
    <motion.button variants={ANIMATIONS.item} className="w-full py-3 border-2 border-red-500/50 text-red-500 rounded-2xl font-bold hover:bg-red-500/10 transition-all text-sm flex items-center justify-center gap-2"><LogOut size={16} />Ø®Ø±ÙˆØ¬</motion.button>
  </motion.div>;
};

// ============================================================================
// MAIN APP
// ============================================================================
const GeminiUltimateApp = () => {
  const { activeTab, setTab, theme, setTheme, cart, notifications, removeNotification } = useUltimateStore();
  const [chatOpen, setChatOpen] = useState(false);
  const tabs = [
    { id: 'home', icon: Home, label: 'Ø®Ø§Ù†Ù‡' },
    { id: 'shop', icon: ShoppingBag, label: 'ÙØ±ÙˆØ´Ú¯Ø§Ù‡' },
    { id: 'cart', icon: ShoppingBag, label: 'Ø³Ø¨Ø¯', badge: cart.length },
    { id: 'profile', icon: User, label: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„' },
  ];
  return <div className={`min-h-screen ${theme === 'dark' ? 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white' : 'bg-gradient-to-br from-white to-gray-100 text-gray-900'} transition-colors`} dir="rtl">
    <motion.header initial={{ y: -100 }} animate={{ y: 0 }} className="sticky top-0 z-40 bg-white/10 backdrop-blur-xl border-b border-white/10"><div className="max-w-2xl mx-auto px-4 py-4 flex items-center justify-between"><button className="p-2 hover:bg-white/10 rounded-lg transition-all"><Menu size={20} /></button><h1 className="text-xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">Gemini âœ¨</h1><button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 hover:bg-white/10 rounded-lg transition-all text-lg">{theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'}</button></div></motion.header>
    <main className="max-w-2xl mx-auto px-4 py-6"><AnimatePresence mode="wait">{activeTab === 'home' && <HomeTab key="home" onChatOpen={() => setChatOpen(true)} />}{activeTab === 'shop' && <ShopTab key="shop" />}{activeTab === 'cart' && <CartTab key="cart" />}{activeTab === 'profile' && <ProfileTab key="profile" />}</AnimatePresence></main>
    <motion.nav initial={{ y: 100 }} animate={{ y: 0 }} className="fixed bottom-0 left-0 right-0 bg-white/10 backdrop-blur-xl border-t border-white/10 z-30"><div className="max-w-2xl mx-auto flex justify-around px-2 py-3">{tabs.map(tab => <motion.button key={`nav-${tab.id}`} whileTap={{ scale: 0.88 }} onClick={() => setTab(tab.id)} className={`relative p-2 rounded-xl transition-all text-xs flex flex-col items-center gap-0.5 ${activeTab === tab.id ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'text-gray-400 hover:text-white'}`}><tab.icon size={20} /><span>{tab.label}</span>{tab.badge > 0 && <motion.span initial={{ scale: 0 }} animate={{ scale: 1 }} className="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">{tab.badge}</motion.span>}</motion.button>)}</div></motion.nav>
    <AIChatSeller isOpen={chatOpen} onClose={() => setChatOpen(false)} />
    <motion.button animate={ANIMATIONS.pulse} onClick={() => setChatOpen(!chatOpen)} className="fixed bottom-24 left-6 w-12 h-12 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center text-white shadow-xl hover:shadow-2xl transition-all z-40" aria-label="Ø¯Ø³ØªÛŒØ§Ø± ÙØ±ÙˆØ´"><MessageCircle size={20} /></motion.button>
    <div className="fixed top-20 left-4 right-4 max-w-sm mx-auto space-y-2 z-50 pointer-events-none"><AnimatePresence>{notifications.map(notif => <div key={notif.id} className="pointer-events-auto"><Toast notification={notif} onClose={() => removeNotification(notif.id)} /></div>)}</AnimatePresence></div>
  </div>;
};

export default GeminiUltimateApp;